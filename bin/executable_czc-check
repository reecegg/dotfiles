#!/bin/bash

# Define the base directory where chezmoi directories are stored
BASE_DIR="$HOME/.local/share"

# Scan for all directories starting with 'chezmoi'
CHEZMOI_DIRS=($(find "$BASE_DIR" -maxdepth 1 -type d -name "chezmoi*"))

# Check if the user provided a file
if [ -z "$1" ]; then
  echo "Usage: czc-track <file>"
  exit 1
fi

FILE="$1"
TRACKED_BY=()

# Iterate over each chezmoi directory to check if the file is tracked
for dir in "${CHEZMOI_DIRS[@]}"; do
  # Capture the output of chezmoi managed
  OUTPUT=$(chezmoi --source="$dir" managed "$FILE" 2>/dev/null)

  # Check if the output is non-empty, meaning the file is tracked
  if [ -n "$OUTPUT" ]; then
    TRACKED_BY+=("$dir")
  fi
done

# Output the results
if [ ${#TRACKED_BY[@]} -eq 0 ]; then
  echo "File '$FILE' is not tracked by any chezmoi repo."
  exit 1
elif [ ${#TRACKED_BY[@]} -eq 1 ]; then
  echo "File '$FILE' is tracked by: ${TRACKED_BY[0]}"
else
  echo "Warning: File '$FILE' is tracked by multiple repos:"
  for repo in "${TRACKED_BY[@]}"; do
    echo "  - $repo"
  done
fi

exit 0
