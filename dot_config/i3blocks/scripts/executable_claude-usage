#!/bin/bash
# Claude Code usage monitor for i3blocks
# Shows 5-hour and 7-day rate limit utilization
#
# Add to ~/.config/i3blocks/config:
#   [claude]
#   command=~/.scripts/claude-usage.sh
#   interval=60
#   markup=pango

set -euo pipefail

CACHE_FILE="/tmp/claude-usage-api.json"
CREDS_FILE="$HOME/.claude/.credentials.json"
CACHE_MAX_AGE=60

# Output nothing if credentials don't exist (Claude not set up)
if [[ ! -f "$CREDS_FILE" ]]; then
    exit 0
fi

# Check for required tools
if ! command -v jq &>/dev/null || ! command -v curl &>/dev/null; then
    echo "ERR"
    exit 0
fi

# Get token, exit silently if not available
token=$(jq -r '.claudeAiOauth.accessToken // empty' "$CREDS_FILE" 2>/dev/null)
if [[ -z "$token" ]]; then
    exit 0
fi

# Refresh cache if missing, empty, or older than CACHE_MAX_AGE
refresh_cache=false
if [[ ! -f "$CACHE_FILE" ]]; then
    refresh_cache=true
elif [[ ! -s "$CACHE_FILE" ]]; then
    refresh_cache=true
else
    cache_age=$(($(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0)))
    if [[ $cache_age -gt $CACHE_MAX_AGE ]]; then
        refresh_cache=true
    fi
fi

if [[ "$refresh_cache" == "true" ]]; then
    response=$(curl -s -m 5 -X GET "https://api.anthropic.com/api/oauth/usage" \
        -H "Authorization: Bearer $token" \
        -H "anthropic-beta: oauth-2025-04-20" 2>/dev/null || echo "")

    if [[ -n "$response" ]] && echo "$response" | jq -e '.five_hour' &>/dev/null; then
        echo "$response" > "$CACHE_FILE"
    elif [[ ! -f "$CACHE_FILE" ]]; then
        # No cache and failed to fetch - exit silently
        exit 0
    fi
    # Otherwise keep stale cache
fi

# Parse cache (with defaults for missing values)
if [[ ! -f "$CACHE_FILE" ]] || [[ ! -s "$CACHE_FILE" ]]; then
    exit 0
fi

five_util=$(jq -r '.five_hour.utilization // empty' "$CACHE_FILE" 2>/dev/null)
week_util=$(jq -r '.seven_day.utilization // empty' "$CACHE_FILE" 2>/dev/null)
five_reset=$(jq -r '.five_hour.resets_at // empty' "$CACHE_FILE" 2>/dev/null)
week_reset=$(jq -r '.seven_day.resets_at // empty' "$CACHE_FILE" 2>/dev/null)

# Exit if no data
if [[ -z "$five_util" ]] && [[ -z "$week_util" ]]; then
    exit 0
fi

# Round percentages
five_pct=$(printf "%.0f" "${five_util:-0}" 2>/dev/null || echo "0")
week_pct=$(printf "%.0f" "${week_util:-0}" 2>/dev/null || echo "0")

# Calculate expected burn rate (% elapsed in window)
# 5h window = 18000 seconds, 7d window = 604800 seconds
calc_expected_pct() {
    local reset_ts="$1"
    local window_secs="$2"
    [[ -z "$reset_ts" ]] && echo "0" && return

    local reset_epoch=$(date -d "$reset_ts" +%s 2>/dev/null || echo "0")
    local now_epoch=$(date +%s)
    local elapsed=$((window_secs - (reset_epoch - now_epoch)))
    [[ $elapsed -lt 0 ]] && elapsed=0
    [[ $elapsed -gt $window_secs ]] && elapsed=$window_secs

    echo $((elapsed * 100 / window_secs))
}

five_expected=$(calc_expected_pct "$five_reset" 18000)
week_expected=$(calc_expected_pct "$week_reset" 604800)

# Format reset time for display
format_reset() {
    local reset_ts="$1"
    local fmt="$2"
    [[ -z "$reset_ts" ]] && echo "" && return
    date -d "$reset_ts" +"$fmt" 2>/dev/null || echo ""
}

five_reset_fmt=$(format_reset "$five_reset" "%H:%M")
week_reset_fmt=$(format_reset "$week_reset" "%a %H:%M")

# Color thresholds (pango markup for i3blocks)
get_color() {
    local pct=${1:-0}
    if [[ $pct -ge 80 ]]; then
        echo "#FF5555"  # red
    elif [[ $pct -ge 60 ]]; then
        echo "#FFFF55"  # yellow
    else
        echo "#AAAAAA"  # gray
    fi
}

# 10-segment bar
make_bar() {
    local pct=${1:-0}
    local color=${2:-#AAAAAA}
    local filled=$((pct / 10))
    [[ $filled -eq 0 ]] && [[ $pct -gt 0 ]] && filled=1
    [[ $filled -gt 10 ]] && filled=10
    local empty=$((10 - filled))

    local bar=""
    for ((i=0; i<filled; i++)); do bar="${bar}▰"; done
    for ((i=0; i<empty; i++)); do bar="${bar}▱"; done

    echo "<span color='$color'>${bar}</span>"
}

# Burn rate color: red over pace, blue under pace, gray on pace
burn_color() {
    local actual=${1:-0}
    local expected=${2:-0}
    local diff=$((actual - expected))

    if [[ $diff -gt 5 ]]; then
        echo "#FF5555"  # over pace (red)
    elif [[ $diff -lt -5 ]]; then
        echo "#8BE9FD"  # under pace (blue)
    else
        echo "#50FA7B"  # on pace (green)
    fi
}

five_color=$(get_color "$five_pct")
week_color=$(get_color "$week_pct")

five_bar=$(make_bar "$five_pct" "$five_color")
week_bar=$(make_bar "$week_pct" "$week_color")

five_burn_color=$(burn_color "$five_pct" "$five_expected")
week_burn_color=$(burn_color "$week_pct" "$week_expected")

# Output with pango markup: bar pct/expected (reset_time)
echo "5h: ${five_bar} <span color='$five_burn_color'>${five_pct}/${five_expected}</span> <span color='#AAAAAA'>(${five_reset_fmt})</span> 7d: ${week_bar} <span color='$week_burn_color'>${week_pct}/${week_expected}</span> <span color='#AAAAAA'>(${week_reset_fmt})</span>"
